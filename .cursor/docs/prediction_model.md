# 예측 모델 설계서

## 1. 개요

본 문서는 캠샤프트 제조 공정의 불량률을 예측하기 위한 통계적 모델의 설계 원리를 상세히 기술합니다. 모델은 다음의 2단계 접근 방식을 통해 현재의 불량률을 정량적으로 계산하고 미래의 공정 불안정성을 예측합니다.

- **1단계: 규격 기반 불량률 계산:** 관리 상한(USL) 및 하한(LSL) 규격을 기준으로 현재 데이터 분포의 **예상 부적합 확률(PPM, Parts Per Million)**을 Z-score를 통해 직접 계산합니다.
- **2단계: 불량률 추세 분석:** 1단계에서 계산된 **예상 불량률의 시간적 변화(기울기)**를 분석하여 공정이 안정화되고 있는지, 또는 악화되고 있는지를 예측하고 사전에 경고합니다.

이 모델은 **`위상각(angle)`**과 **`토크(torque)`** 등 주요 관리 지표에 모두 적용됩니다.

## 2. 1단계: 규격 기반 예상 불량률(PPM) 계산

### 2.1. 목표

- 현재 공정의 평균($\mu$)과 표준편차($\sigma$)를 기반으로, 생산품이 주어진 규격(LSL/USL)을 벗어날 확률을 통계적으로 계산합니다.

### 2.2. 핵심 파라미터

- **관리 규격 (Specification Limits):**
  - `상한 규격 (USL)`: 0.2500
  - `하한 규격 (LSL)`: -0.2500
  - 이 값들은 시스템 설정으로 관리되어야 하며, 필요시 변경 가능해야 합니다.
- **통계치 계산 단위:** 모델의 안정성을 위해, 최근 N개(예: 500개)의 데이터를 기준으로 `평균($\mu$)`과 `표준편차($\sigma$)`를 실시간으로 계산합니다.

### 2.3. 계산 절차

1.  **Z-score 계산 (for USL/LSL):** 현재 공정의 평균과 표준편차를 기준으로, **고정된 규격값이 Z-분포 상에서 어디에 위치하는지**를 계산합니다.
    \[ Z*{USL} = \frac{(USL - \mu)}{\sigma} \]
    \[ Z*{LSL} = \frac{(LSL - \mu)}{\sigma} \]

2.  **부적합 확률 계산:**

    - 계산된 Z값을 표준 정규 분포의 **누적 분포 함수(Cumulative Distribution Function, CDF)**에 대입하여 규격을 벗어날 확률을 구합니다.
    - `상한 부적합 확률 P(X > USL) = 1 - CDF(Z_{USL})`
    - `하한 부적합 확률 P(X < LSL) = CDF(Z_{LSL})`

3.  **최종 예상 불량률 (PPM):**
    - `총 부적합 확률 = P(X > USL) + P(X < LSL)`
    - `예상 불량률 (PPM) = 총 부적합 확률 * 1,000,000`

## 3. 2단계: 불량률 추세 분석 및 예측

### 3.1. 목표

- 1단계에서 계산된 **'예상 불량률(PPM)'**이 시간에 따라 어떻게 변하는지를 추적하여, 공정이 안정화되는 추세인지, 악화되는 추세인지를 미리 예측합니다.

### 3.2. 기울기 분석

- **데이터 수집:** 일정 시간 간격(예: 10분마다)으로 1단계에서 계산된 **'예상 불량률(PPM)'** 값을 시계열 데이터로 `distribution_analysis` 테이블에 저장합니다.
- **기울기 계산:** 저장된 '예상 불량률' 시계열 데이터에 대해 선형 회귀 분석을 적용하여 **시간에 따른 불량률의 변화율(기울기)**을 계산합니다.
  - `기울기 > 0`: 불량률 증가 추세 (공정 악화)
  - `기울기 < 0`: 불량률 감소 추세 (공정 안정화)

### 3.3. 예측 및 알람

- **정량적 알람 (1단계 기반):**
  - 계산된 '예상 불량률(PPM)'이 사전에 정의된 임계값(예: 1000 PPM)을 초과하면 **'주의'** 알람 발생.
- **추세 기반 알람 (2단계 기반):**
  - 계산된 '불량률 기울기'가 가파른 양수 값을 보이며 특정 임계값을 초과하면, 현재 불량률이 낮더라도 미래의 위험을 예측하는 **'경고'** 알람 발생.
  - 이를 통해 실제 불량이 발생하기 전에 선제적인 조치를 취할 수 있도록 유도합니다.

## 4. 데이터 저장

- 1, 2단계에서 계산된 모든 핵심 지표들은 `distribution_analysis` 테이블에 저장되어야 합니다.
  - `평균(mean)`, `표준편차(std_dev)`
  - `예상_불량률_PPM (predicted_ppm)`
  - `불량률_기울기 (ppm_slope)`

## 5. 모델 검증 및 개선

- 실제 불량률과 '예상 불량률(PPM)' 간의 상관관계를 분석하여 모델의 정확도를 검증합니다.
- '불량률 기울기' 알람의 선행 예측 능력을 평가하고, 기울기 계산에 사용되는 데이터 기간(N) 등의 하이퍼파라미터를 최적화합니다.
